{% extends "base.html" %}
{% block title %}Video Recording{% endblock %}
{% block content %}
<h1>Please read the instructions below</h1>

<ul>
    <li>Check the video player below to make sure you are ready</li>
    <li>When you are ready press the start recording button</li>
    <li>It will record for 5 seconds and then show you the video to choose whether to approve it or not</li>
</ul>

<h1>Webcam Video Recorder</h1>
<div id="recording-section" style="display:flex; align-items:center;">
<video id="videoPlayer" autoplay controls style="flex:1; max-width: 600px;"></video>
<button id="startRecordingButton" style="margin-left: 50px;" class="btn btn-primary">Start Recording</button>
</div>

<div id="review-section" style="display:none; align-items:center;">
<video id="reviewVideoPlayer" autoplay controls style="flex:1; max-width: 600px;"></video>
<div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <p>Do you approve this video?</p>
    <div>
    <button id="approveButton" class="btn btn-primary">Approve</button>
    <button id="recordAgainButton" class="btn btn-secondary">Record Again</button>
    </div>
</div>
</div>

<script>
const videoPlayer = document.getElementById('videoPlayer');
let reviewVideoPlayer = document.getElementById('reviewVideoPlayer');
const startRecordingButton = document.getElementById('startRecordingButton');
const approveButton = document.getElementById('approveButton');
const recordAgainButton = document.getElementById('recordAgainButton');
let recordingSection = document.getElementById('recording-section');
let reviewSection = document.getElementById('review-section');
const constraints = {
    video: true
};
let streamObject;
navigator.mediaDevices.getUserMedia(constraints)
    .then((stream) => {
    videoPlayer.srcObject = stream;
    window.mediaStream = stream;
    streamObject = stream;
    })
    .catch((err) => {
    console.error(err);
    });

var recordedChunks = [];

function handleDataAvailable(event) {
    recordedChunks.push(event.data);
}

async function startRecording() {
  recordedChunks = [];

  const mediaRecorder = new MediaRecorder(streamObject);
  mediaRecorder.ondataavailable = async (e) => {
    //this event is fired after stopping the recorder in couple of seconds
    //thats we was rendering an empty video so we show the video when we have data
    if(e.data.size > 0){
      recordedChunks.push(e.data);
      const recordedBlob = new Blob(recordedChunks, { type: recordedChunks[0].type });
      const recordedUrl = window.webkitURL.createObjectURL(recordedBlob);
      recordingSection.style.display = 'none';
      reviewSection.style.display = 'flex';
      reviewVideoPlayer.src = recordedUrl;
      await reviewVideoPlayer.load();
      await reviewVideoPlayer.play();
    }
  };

  await mediaRecorder.start();


  await new Promise((resolve) => {
    setTimeout(async () => {
      await mediaRecorder.stop();
      resolve();
    }, 2000);
  });

}



function approveRecording() {
  const formData = new FormData();
  formData.append('video', new Blob(recordedChunks, { type: recordedChunks[0].type }));

  fetch('/Record', {
    method: 'POST',
    body: formData
  })
  .then((response) => {
    // Handle the response from the server
    console.log(response);
  })
  .catch((error) => {
    // Handle any errors that occur during the fetch request
    console.error(error);
  });

  // Hide the review section and reset the video player
  reviewSection.style.display = 'none';
  reviewVideoPlayer.pause();
  reviewVideoPlayer.currentTime = 0;

 //   Show the recording section again and start recording
   recordingSection.style.display = 'flex';
//   startRecording();
}


function recordAgain() {
    reviewSection.style.display = 'none';
    recordingSection.style.display = 'flex';
    reviewVideoPlayer.pause();
    reviewVideoPlayer.currentTime = 0;
    startRecording();

}

startRecordingButton.addEventListener('click',startRecording);
approveButton.addEventListener('click', approveRecording);
recordAgainButton.addEventListener('click', recordAgain);
</script>
{% endblock %}
